<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accurate Dual Compass</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f4f4f4;
      font-family: Arial, sans-serif;
    }

    .compass-container {
      display: flex;
      gap: 50px;
    }

    .compass {
      position: relative;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 5px solid #ccc;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      background: url('https://purepng.com/public/uploads/large/purepng.com-compasscompassinstrumentnavigationcardinal-directionspointsdiagram-1701527842316onq7x.png')
        no-repeat center / contain;
    }

    .arrow {
      position: absolute;
      width: 0;
      height: 0;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      border-style: solid;
      border-width: 30px 20px 0 20px;
      border-color: red transparent transparent transparent;
      z-index: 1;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="compass-container">
    <div class="compass" id="compass1">
      <div class="arrow"></div>
    </div>
    <div class="compass" id="compass2">
      <div class="arrow"></div>
    </div>
  </div>
  <button id="start">Start Compass</button>
  <script>
    const compass1 = document.getElementById("compass1");
    const compass2 = document.getElementById("compass2");
    const startButton = document.getElementById("start");

    let initialHeading = null;
    let currentHeading = 0;
    let gyroAngle = 0; // To track the second compass
    let lastUpdateTime = null;
    let isSecondCompassSynchronized = false;

    const isFlat = ({ x, y, z }) => {
      // Device is flat if Z-axis (gravity) is dominant
      return Math.abs(z) > Math.abs(x) && Math.abs(z) > Math.abs(y);
    };

    const smoothValue = (current, target, factor) => {
      return current + (target - current) * factor;
    };

    const startCompass = () => {
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientation", handleDeviceOrientation);
      }

      if (window.DeviceMotionEvent) {
        window.addEventListener("devicemotion", handleDeviceMotion);
      }
    };

    const handleDeviceOrientation = (event) => {
      let heading = event.webkitCompassHeading;

      // If webkitCompassHeading isn't available, fallback to event.alpha (this works for devices without magnetic sensors)
      if (heading === undefined || heading === null) {
        heading = Math.abs(event.alpha - 360);
      }

      // If we don't have a valid heading, we should ignore it.
      if (heading !== undefined && heading !== null) {
        if (initialHeading === null) {
          initialHeading = heading; // Set the initial heading when the first event is triggered.
        }

        const adjustedHeading = heading - initialHeading; // Adjust the heading based on the initial value.

        // Apply rotation to the first compass
        compass1.style.transform = `rotate(${-adjustedHeading}deg)`;
        currentHeading = adjustedHeading;

        // If the second compass hasn't been synchronized yet, synchronize it with the first compass
        if (!isSecondCompassSynchronized) {
          gyroAngle = adjustedHeading;
          compass2.style.transform = `rotate(${-gyroAngle}deg)`; // Sync second compass with first
          isSecondCompassSynchronized = true; // Mark as synchronized
        }
      }
    };

    const handleDeviceMotion = (event) => {
      const acceleration = event.accelerationIncludingGravity;
      if (isFlat(acceleration)) {
        const now = Date.now();
        if (!lastUpdateTime) {
          lastUpdateTime = now;
          return;
        }
        const deltaTime = (now - lastUpdateTime) / 1000; // in seconds
        lastUpdateTime = now;

        const rotationRate = event.rotationRate.alpha || 0;
        gyroAngle += rotationRate * deltaTime;
        gyroAngle %= 360; // Keep within 0-360 range

        // Now, gyroAngle operates independently of the first compass
        compass2.style.transform = `rotate(${-gyroAngle}deg)`;
      }
    };

    startButton.addEventListener("click", startCompass);
  </script>
</body>
</html>
